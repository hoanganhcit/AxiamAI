<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bastion + Facial Sign-In — Simulation Flow</title>
    
    <!-- Favicon -->
    <link rel="icon" href="img/icon1.png">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f8f9fa;
        }

        #diagram {
            min-height: 200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            flex-wrap: wrap;
        }

        .node {
            padding: 8px 12px;
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            width: calc(100% / 6 - 15px);
            transition: all 0.3s;
        }

        .node.active {
            border-color: #0d6efd;
            background: #e7f1ff;
            box-shadow: 0 0 10px rgba(13, 110, 253, 0.3);
        }

        .node.done {
            border-color: #198754;
            background: #e9f8f1;
        }

        #timeline li {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
        }

        #timeline li.active {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }

        #timeline li.done {
            border-color: #198754;
            background-color: #e9f8f1;
        }

        .log-line {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }

        .log-ok {
            border-color: #a3e4b3;
            background-color: #e9f8f1;
            color: #0f5132;
        }

        .log-fail {
            border-color: #f5c2c7;
            background-color: #f8d7da;
            color: #842029;
        }
        .fs-25 {
            font-size: 25px;
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h4 fw-bold">Bastion Host + Facial Sign-In — Simulation Flow</h1>
                <p class="text-muted small">Demo the end-to-end, passwordless access path with liveness, token binding,
                    and zero-trust bastion policy.</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary btn-sm" id="startBtn"><i class="bi bi-play"></i> Start</button>
                <button class="btn btn-outline-secondary btn-sm" id="pauseBtn" disabled><i class="bi bi-pause"></i> Pause</button>
                <button class="btn btn-outline-secondary btn-sm" id="resetBtn" disabled><i class="bi bi-arrow-repeat"></i> Reset</button>
            </div>
        </div>

        <!-- Scenario + Speed -->
        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title mb-3">Attack Simulation</h6>
                        <div class="d-grid gap-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attackPhishing">
                                <label class="form-check-label" for="attackPhishing">Phishing (no passwords to
                                    steal)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attackMitm">
                                <label class="form-check-label" for="attackMitm">MITM (token + mTLS binding)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attackReplay">
                                <label class="form-check-label" for="attackReplay">Replay (nonce + liveness)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="attackDeepfake">
                                <label class="form-check-label" for="attackDeepfake">Deepfake (active challenge)</label>
                            </div>
                        </div>
                        <p class="text-muted small mt-2">Toggle a threat vector to see where the flow is blocked by
                            design.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title mb-3">Playback Speed</h6>
                        <input type="range" class="form-range" min="0.5" max="2" step="0.25" id="speedRange" value="1">
                        <div class="small text-muted" id="speedValue">1x</div>
                        <div class="mt-3 bg-light p-2 rounded small">
                            <strong>Policy Highlights</strong>
                            <ul class="mb-0 ps-3">
                                <li>On-device face capture with active liveness</li>
                                <li>Template match → short-lived, audience-scoped token</li>
                                <li>Token bound to device (mTLS) and time window</li>
                                <li>Bastion evaluates RBAC, posture, IP, time, risk</li>
                                <li>Ephemeral credentials to target; no standing keys</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title mb-3">Run Status</h6>
                        <div id="runStatus" class="small fw-bold text-capitalize">idle</div>
                        <p class="text-muted small" id="statusDesc">Start to animate the full path; pause anytime to
                            explain a step.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Diagram -->
        <div class="card mb-4">
            <div id="diagram" class="d-flex justify-content-between flex-wrap">
                <!-- Render từng step ở đây bằng JS -->
            </div>
        </div>

        <!-- Timeline + Logs -->
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title mb-3">Timeline</h6>
                        <ol class="list-group list-group-numbered small" id="timeline"></ol>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title mb-3">Event Log</h6>
                        <div class="d-grid gap-2 small" id="eventLog">
                            <div class="text-muted">No events yet. Press Start to run the simulation.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="card mt-4">
            <div class="card-body small text-muted">
                <strong>How to demo</strong>
                <ol class="ps-3">
                    <li>Toggle one or more threat vectors above (e.g., Deepfake).</li>
                    <li>Click <strong>Start</strong> to animate the steps and watch where the flow blocks.</li>
                    <li>Use <strong>Pause</strong> to explain a step; <strong>Reset</strong> to start over.</li>
                    <li>Adjust <strong>Playback Speed</strong> for a quicker or slower walkthrough.</li>
                </ol>
                <div class="mt-2">Tip: This demo is passwordless by design—no secrets to phish, tokens are device/time
                    bound, and bastion enforces policy just-in-time.</div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            const steps = [
                {
                    id: "capture",
                    title: "User Device",
                    icon: "bi-camera"
                },
                {
                    id: "liveness",
                    title: "Liveness",
                    icon: "bi-activity"
                },
                {
                    id: "match",
                    title: "Face Match",
                    icon: "bi-fingerprint"
                },
                {
                    id: "issue",
                    title: "Token Issuer (IdP)",
                    icon: "bi-key"
                },
                {
                    id: "connect",
                    title: "Bastion Gateway",
                    icon: "bi-shield-lock"
                },
                {
                    id: "server",
                    title: "Target Server(s)",
                    icon: "bi-hdd-network"
                }
            ];

            const $diagram = $("#diagram");
            $diagram.empty();

            steps.forEach(s => {
            $diagram.append(`
                <div class="node diagram-step card text-center" id="node-${s.id}">
                <div class="card-body">
                    <i class="bi ${s.icon} fs-25  mb-3"></i>
                    <h6 class="card-title">${s.title}</h6>
                    <div class="text-success mt-2">
                    <i class="bi bi-check-circle-fill"></i> OK
                    </div>
                </div>
                </div>
            `);
            });
            const timelineSteps = [
                { id: "capture", title: "Capture Face", desc: "Camera capture with secure enclave.", duration: 1200 },
                { id: "liveness", title: "Active Liveness", desc: "Blink/turn challenge to defeat deepfake.", duration: 1600 },
                { id: "match", title: "Face Template Match", desc: "Compare encrypted template.", duration: 1400 },
                { id: "issue", title: "Issue Short-Lived Token", desc: "mTLS bound token.", duration: 1100 },
                { id: "connect", title: "Connect via Bastion", desc: "Client connects, policy eval.", duration: 1300 },
                { id: "authorize", title: "Authorize Session", desc: "RBAC, posture, risk, etc.", duration: 1000 },
                { id: "establish", title: "Establish Session", desc: "Ephemeral creds tunneled.", duration: 1200 },
            ];

            const attacks = {
                phishing: [],
                mitm: ["connect", "authorize", "establish"],
                replay: ["liveness", "match"],
                deepfake: ["liveness"],
            };

            let cursor = -1, status = "idle", speed = 1, timer = null;
            const $timeline = $("#timeline");
            const $eventLog = $("#eventLog");
            const $status = $("#runStatus");
            const $statusDesc = $("#statusDesc");

            timelineSteps.forEach(s => {
                $timeline.append(`<li class="list-group-item" data-id="${s.id}">
          <div class="fw-bold">${s.title}</div>
          <div class="small text-muted">${s.desc} (~${s.duration}ms)</div>
        </li>`);
            });

            function updateUI() {
                $timeline.find("li").removeClass("active done");
                $(".node").removeClass("active done");
                timelineSteps.forEach((s, i) => {
                    if (i < cursor) {
                        $timeline.find(`[data-id=${s.id}]`).addClass("done");
                        $(`#node-${s.id}`).addClass("done");
                    } else if (i === cursor) {
                        $timeline.find(`[data-id=${s.id}]`).addClass("active");
                        $(`#node-${s.id}`).addClass("active");
                    }
                });
                $status.text(status);
                $statusDesc.text(status === "failed" ? "Flow blocked by attack." : "Running simulation.");
            }

            function logEvent(ok, text, meta) {
                const cssClass = ok ? "log-ok" : "log-fail";
                $eventLog.append(`<div class="log-line ${cssClass}"><div class="fw-bold">${text}</div><div class="small">${meta}</div></div>`);
            }

            function reset() {
                cursor = -1;
                status = "idle";
                $eventLog.html('<div class="text-muted">No events yet. Press Start.</div>');
                $(".node").removeClass("active done");
                updateUI();
                clearTimeout(timer);
            }

            function runStep() {
                if (cursor >= timelineSteps.length || status !== "running") return;
                const step = timelineSteps[cursor];
                const duration = Math.max(400, step.duration / speed);
                const activeAttacks = [];
                if ($("#attackPhishing").is(":checked")) activeAttacks.push("phishing");
                if ($("#attackMitm").is(":checked")) activeAttacks.push("mitm");
                if ($("#attackReplay").is(":checked")) activeAttacks.push("replay");
                if ($("#attackDeepfake").is(":checked")) activeAttacks.push("deepfake");
                const blocked = activeAttacks.some(atk => attacks[atk].includes(step.id));

                timer = setTimeout(() => {
                    if (blocked) {
                        status = "failed";
                        logEvent(false, `Blocked: ${step.title}`, "Attack prevented.");
                        updateUI();
                        return;
                    }
                    logEvent(true, step.title, step.desc);
                    if (cursor === timelineSteps.length - 1) {
                        status = "done";
                        logEvent(true, "Access Granted", "Session established.");
                    } else {
                        cursor++;
                        runStep();
                    }
                    updateUI();
                }, duration);
            }

            $("#startBtn").click(function () {
                if (status === "idle" || status === "done" || status === "failed") {
                    reset();
                    status = "running";
                    cursor = 0;
                    $eventLog.empty();
                    runStep();
                } else if (status === "paused") {
                    status = "running";
                    runStep();
                }
                updateUI();
                $("#pauseBtn").prop("disabled", false);
                $("#resetBtn").prop("disabled", false);
            });

            $("#pauseBtn").click(function () {
                if (status === "running") {
                    status = "paused";
                    clearTimeout(timer);
                }
                updateUI();
            });

            $("#resetBtn").click(function () {
                reset();
                $(this).prop("disabled", true);
                $("#pauseBtn").prop("disabled", true);
            });

            $("#speedRange").on("input", function () {
                speed = parseFloat($(this).val());
                $("#speedValue").text(speed.toFixed(2) + "x");
            });

            reset();
        });
    </script>
</body>

</html>