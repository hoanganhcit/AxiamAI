<!doctype html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>LexFlow — Client & Case Workspace (Bootstrap + jQuery)</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        :root {
            --brand-grad-start: #4f46e5;
            /* indigo-600 */
            --brand-grad-mid: #2563eb;
            /* blue-600 */
            --brand-grad-end: #06b6d4;
            /* cyan-500 */
            --panel-bg: #ffffff;
            --page-bg: #f8f8fc;
            /* slate-50 */
        }

        body {
            background: var(--page-bg);
        }

        .brand-mark {
            height: 40px;
            width: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--brand-grad-start), var(--brand-grad-mid), var(--brand-grad-end));
            box-shadow: 0 6px 18px rgba(37, 99, 235, 0.08);
        }

        .sidebar .nav-link {
            color: #334155;
        }

        .sidebar .nav-link.active {
            background: #f1f5f9;
            font-weight: 600;
            border-radius: 8px;
        }

        .card-rounded {
            border-radius: 12px;
        }

        .badge-pill {
            border-radius: 999px;
            padding: .35rem .7rem;
            font-size: .75rem;
        }

        .stage-column {
            min-width: 260px;
        }

        .matter-card {
            border: 1px solid #e6eef6;
            background: var(--panel-bg);
            border-radius: 12px;
            padding: 12px;
        }

        .matter-card .title {
            font-weight: 600;
        }

        .scroll-x {
            overflow-x: auto;
        }

        header.topbar {
            backdrop-filter: blur(6px);
            background: rgba(255, 255, 255, 0.85);
            border-bottom: 1px solid #e6eef6;
        }

        .tiny {
            font-size: .78rem;
            color: #64748b;
        }

        .mini-cal {
            max-width: 240px;
        }

        @media (max-width: 991px) {
            .sidebar {
                display: none;
            }
        }

        :root {
            --card-radius: 12px;
            --accent: linear-gradient(45deg, #00ccff, #1d5add);
            --bg-primary: #18d3ff;
        }

        body {
            background: #f8fafc;
            color: #0f172a;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
            font-size: 14px;
        }

        .btn {
            --bs-btn-font-size: 0.875rem;
        }

        .form-control {
            font-size: 0.875rem;
        }

        .rounded-2xl {
            border-radius: var(--card-radius)
        }

        .sidebar-btn {
            position: relative;
            z-index: 1;
            height: 48px;
            line-height: 48px;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 1px;
            display: inline-block;
            padding: 0 10px !important;
            text-align: center;
            text-transform: uppercase;
            background-size: 200% auto;
            box-shadow: 0 3ox 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .sidebar-btn.active {

            background: #18d3ff;
            color: #fff;
        }

        .btn-primary {
            background: #18d3ff;
            border-color: #18d3ff;
        }

        .btn-primary:hover,
        .btn-primary:focus {
            background: #11b6db;
            border-color: #11b6db;
        }

        .progress-bar {
            background-color: var(--bg-primary);
        }

        .topbar {
            backdrop-filter: blur(6px);
            background: rgba(255, 255, 255, 0.85);
            border-bottom: 1px solid #e6edf3
        }

        .card-panel {
            background: #fff;
            border: 1px solid #e6edf3;
            border-radius: 12px
        }

        .stage-column {
            min-width: 260px
        }

        .mat-card {
            border: 1px solid #eef2ff;
            border-radius: 12px;
            background: #fff;
            padding: 12px
        }

        .badge-pill {
            border-radius: 999px
        }

        .underline-btn {
            background: none;
            border: none;
            color: #0f172a;
            text-decoration: underline;
            padding: 0
        }

        .overflow-x-auto {
            overflow-x: auto
        }

        .sidebar {
            position: sticky;
            top: 12px
        }

        .muted {
            color: #6b7280
        }

        .small-muted {
            font-size: 12px;
            color: #6b7280
        }

        .card-compact .card-body {
            padding: 0.65rem
        }

        /* make horizontal board scroll smooth */
        .board-wrap {
            display: flex;
            gap: 16px;
            padding-bottom: 8px
        }

        .card-shadow {
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06)
        }

        .table {
            font-size: 0.875rem;
        }

        .accordion-button {
            font-size: 14px;
            font-weight: 500;
        }

        .nav-tabs {
            border: 0;
            background: #ebebeb;
            border-bottom: none;
            background-color: #f9fafb;
            padding: 6px;
            border-radius: 8px;
            display: inline-flex;
            gap: 6px;
        }

        .nav-tabs .nav-link {
            color: #545454;
            border-radius: 8px;
            padding: 5px 15px;
            transition: none;
            border: none;
            background: transparent;
            color: #4b5563;
            font-weight: 500;
            border-radius: 6px;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .nav-tabs .nav-link.active {
            background-color: white;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            color: #111827;
            font-weight: 600;
        }

        .btn-group-sm>.btn,
        .btn-sm {
            font-size: 12px;
        }

        table tbody td {
            font-size: .78rem;
            vertical-align: middle;
        }

        .accordion-border {
            border: var(--bs-accordion-border-width) solid var(--bs-accordion-border-color);
        }

        #docAlert {
            transition: all 0.4s ease;
        }

        /* responsive tweaks */
        @media (max-width:991px) {
            .sidebar {
                position: relative
            }
        }

        .fc .fc-col-header-cell-cushion {
            text-decoration: none;
            color: #2e2e2e;
        }

        .fc .fc-daygrid-day-number {
            text-decoration: none;
        }

        .fc .fc-daygrid-day-frame {
            min-height: 100px;
        }
    </style>
</head>

<body>
    <!-- Top Bar -->
    <header class="topbar sticky-top">
        <div class="container-fluid px-3 py-2 d-flex align-items-center gap-3">
            <div class="d-flex align-items-center gap-2">
                <div class="brand-mark"></div>
                <div>
                    <div style="font-weight:700; font-size:0.95rem; color:#0f172a;">LexFlow</div>
                    <div class="tiny">Client & Case Workspace</div>
                </div>
            </div>

            <div class="flex-grow-1 ms-3">
                <div class="position-relative">
                    <i class="bi bi-search position-absolute" style="left:12px;top:10px;color:#94a3b8"></i>
                    <input id="globalSearch" class="form-control form-control-sm ps-5 rounded-pill"
                        placeholder="Search clients, matters, invoices, hearings…" />
                </div>
            </div>

            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-primary btn-sm rounded-pill" data-bs-toggle="modal"
                    data-bs-target="#newClientModal"><i class="bi bi-plus-lg me-1"></i> New Client</button>
                <button class="btn btn-outline-primary btn-sm rounded-pill" data-bs-toggle="modal"
                    data-bs-target="#newMatterModal"><i class="bi bi-plus-lg me-1"></i> New Matter</button>
                <button class="btn btn-outline-secondary btn-sm rounded-pill" data-bs-toggle="modal"
                    data-bs-target="#registerModal">Register</button>
                <button class="btn btn-dark btn-sm"><i class="bi bi-gear"></i></button>
            </div>
        </div>
    </header>

    <!-- Body -->
    <div class="container-fluid px-3 py-4">
        <div class="row gx-4">
            <!-- Sidebar -->
            <aside class="col-lg-3 col-xl-2 mb-4 sidebar">
                <nav class="bg-white p-2 rounded-3 border-0">
                    <div class="nav flex-column">
                        <a href="#" class="nav-link active" data-tab="dashboard"><i class="bi bi-grid me-2"></i>
                            Dashboard</a>
                        <a href="#" class="nav-link" data-tab="clients"><i class="bi bi-people me-2"></i> Clients</a>
                        <a href="#" class="nav-link" data-tab="matters"><i class="bi bi-briefcase me-2"></i> Matters</a>
                        <a href="#" class="nav-link" data-tab="court"><i class="bi bi-bank2 me-2"></i> Court</a>
                        <a href="#" class="nav-link" data-tab="docs"><i class="bi bi-file-earmark-text me-2"></i>
                            Documents</a>
                        <a href="#" class="nav-link" data-tab="calendar"><i class="bi bi-calendar-event me-2"></i>
                            Calendar</a>
                        <a href="#" class="nav-link" data-tab="billing"><i class="bi bi-credit-card-2-front me-2"></i>
                            Billing</a>
                        <a href="#" class="nav-link" data-tab="messages"><i class="bi bi-chat-dots me-2"></i>
                            Messages</a>
                    </div>
                </nav>

            </aside>

            <!-- Main -->
            <main class="col-lg-9 col-xl-10">
                <!-- Dashboard Tab -->
                <section id="tab-dashboard">
                    <!-- Stats -->
                    <div class="row g-3 mb-3">
                        <div class="col-12 col-sm-6 col-xl-3">
                            <div class="card card-rounded border-0 p-3">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="tiny">Active Matters</div>
                                        <div style="font-weight:700; font-size:1.45rem;" id="stat-active-matters">0
                                        </div>
                                        <div class="tiny">+2 this month</div>
                                    </div>
                                    <div class="text-end"><i class="bi bi-briefcase"
                                            style="font-size:1.5rem;color:#2563eb;"></i></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-sm-6 col-xl-3">
                            <div class="card card-rounded border-0 p-3">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="tiny">Upcoming Hearings</div>
                                        <div style="font-weight:700; font-size:1.45rem;" id="stat-hearings">0</div>
                                        <div class="tiny">Next 60 days</div>
                                    </div>
                                    <div class="text-end"><i class="bi bi-gavel"
                                            style="font-size:1.5rem;color:#0ea5a4;"></i></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-sm-6 col-xl-3">
                            <div class="card card-rounded border-0 p-3">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="tiny">Outstanding Invoices</div>
                                        <div style="font-weight:700; font-size:1.45rem;" id="stat-invoices">0</div>
                                        <div class="tiny" id="stat-invoices-amount">$0 due</div>
                                    </div>
                                    <div class="text-end"><i class="bi bi-credit-card-2-front"
                                            style="font-size:1.5rem;color:#ef4444;"></i></div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-sm-6 col-xl-3">
                            <div class="card card-rounded border-0 p-3">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <div class="tiny">New Messages</div>
                                        <div style="font-weight:700; font-size:1.45rem;">4</div>
                                        <div class="tiny">Since yesterday</div>
                                    </div>
                                    <div class="text-end"><i class="bi bi-chat-left-text"
                                            style="font-size:1.5rem;color:#8b5cf6;"></i></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main grid: Matters board + right column -->
                    <div class="row g-4">
                        <div class="col-12 col-xl-8">
                            <div class="card card-rounded border-0">
                                <div class="card-body">
                                    <h5 class="card-title mb-1">Matters Board</h5>
                                    <div class="tiny mb-3">Track progress across stages</div>

                                    <div class="d-flex gap-3 scroll-x" id="stagesContainer" style="padding-bottom:6px;">
                                        <!-- Stage columns will be injected here by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-12 col-xl-4">
                            <div class="mb-3 card card-rounded border-0">
                                <div class="card-body">
                                    <h6 class="mb-0">Upcoming Hearings <small class="tiny">60-day window</small></h6>
                                    <div class="mt-3 table-responsive">
                                        <table class="table table-sm mb-0" id="hearingsTable">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Matter</th>
                                                    <th>Court</th>
                                                    <th>Room</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="card card-rounded border-0 mt-3">
                                <div class="card-body">
                                    <h6 class="mb-0">Mini Calendar <small class="tiny">Plan filings & deadlines</small>
                                    </h6>
                                    <div class="mt-3">
                                        <input type="date" id="miniCalendar" class="form-control mini-cal" />
                                        <div class="tiny mt-2">Selected: <span id="miniCalSelected">—</span></div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </section>

                <!-- Clients Tab -->
                <section id="tab-clients" class="d-none">
                    <div class="card card-rounded border-0">
                        <div class="card-body">
                            <h5>Clients <small class="tiny">Directory & quick actions</small></h5>
                            <div class="table-responsive mt-3">
                                <table class="table table-hover" id="clientsTable">
                                    <thead>
                                        <tr>
                                            <th>Client</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Company</th>
                                            <th>Court Type</th>
                                            <th class="text-end">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Matters Tab -->
                <section id="tab-matters" class="d-none">
                    <div class="card card-rounded border-0 p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h5 class="mb-0">Matters</h5>
                                <div class="tiny">Board / List</div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal"
                                    data-bs-target="#newMatterModal">New Matter</button>
                                <button class="btn btn-sm btn-outline-secondary">Import</button>
                            </div>
                        </div>

                        <div id="mattersListArea">
                            <!-- list injected by JS -->
                        </div>
                    </div>
                </section>

                <!-- Court Tab (simple) -->
                <section id="tab-court" class="d-none">
                    <div class="card card-rounded border-0">
                        <div class="card-body">
                            <h5>Court & Hearings</h5>
                            <div class="tiny">Rooms, filings, appearances</div>
                            <div class="table-responsive mt-3">
                                <table class="table table-sm" id="courtTable">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Matter</th>
                                            <th>Court / Type</th>
                                            <th>Room</th>
                                            <th>Status</th>
                                            <th>Notify</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Docs Tab (placeholder) -->
                <section id="tab-docs" class="d-none">
                    <div class="card card-rounded border-0">
                        <div class="card-body">
                            <h5>Documents</h5>
                            <p class="tiny">Secure workspace for files</p>
                            <div class="border border-dashed rounded-3 p-4 text-center mt-3">
                                <i class="bi bi-upload" style="font-size:1.5rem;color:#94a3b8;"></i>
                                <p class="mb-0 mt-2">Drag & drop or click to upload</p>
                                <small class="tiny text-muted">PDF, DOCX, PNG (max 50 MB)</small>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Calendar Tab (placeholder) -->
                <section id="tab-calendar" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Master Calendar</h5>
                    </div>
                    <div id="calendar"></div>
                </section>

                <!-- Billing Tab (placeholder) -->
                <section id="tab-billing" class="d-none">
                    <div class="card card-rounded border-0 p-3">
                        <h5>Billing</h5>
                        <div class="tiny">Track payments & status</div>
                        <div class="mt-3 table-responsive">
                            <table class="table" id="invoicesTable">
                                <thead>
                                    <tr>
                                        <th>Invoice</th>
                                        <th>Client</th>
                                        <th>Matter</th>
                                        <th>Amount</th>
                                        <th>Due</th>
                                        <th>Status</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Messages Tab (placeholder) -->
                <section id="tab-messages" class="d-none">
                    <div class="card card-rounded border-0 p-3">
                        <h5>Messages</h5>
                        <div class="tiny">Client & counsel threads</div>
                        <div class="mt-3">
                            <div class="border rounded-2 p-3" style="height:300px; overflow:auto;">
                                <div class="mb-3"><strong>Henry Quach</strong> <small class="tiny text-muted">2m
                                        ago</small>
                                    <div> Please review the draft disclosure list attached.</div>
                                </div>
                                <!-- more -->
                            </div>
                            <div class="d-flex gap-2 mt-2">
                                <input class="form-control form-control-sm" placeholder="Write a message…" />
                                <button class="btn btn-primary btn-sm">Send</button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Client Profile -->
                <section id="tab-client-profile" class="d-none">
                    <div class="card card-rounded border-0 p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Client Profile</h5>
                            <button class="btn btn-sm btn-outline-secondary" id="btnBackDashboard"><i
                                    class="bi bi-arrow-left"></i> Back</button>
                        </div>
                        <div id="clientProfileBody">
                            <!-- content will be injected -->
                        </div>
                    </div>
                </section>

            </main>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="newClientModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="newClientForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Onboard Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label class="form-label tiny">Full name</label><input name="clientName"
                            class="form-control form-control-sm" required></div>
                    <div class="mb-2"><label class="form-label tiny">Email</label><input name="clientEmail"
                            class="form-control form-control-sm" type="email"></div>
                    <div class="mb-2"><label class="form-label tiny">Phone</label><input name="phone"
                            class="form-control form-control-sm"></div>
                    <div class="mb-2"><label class="form-label tiny">Company</label><input name="company"
                            class="form-control form-control-sm"></div>
                    <div class="mb-2">
                        <label class="form-label tiny">Court Client Document Type</label>
                        <select id="newClientDocType" class="form-select form-select-sm">
                            <option value="Civil Litigation">Civil Litigation</option>
                            <option value="Family Law">Family Law</option>
                            <option value="Criminal Defense">Criminal Defense</option>
                            <option value="Immigration Law">Immigration Law</option>
                            <option value="Corporate Law">Corporate Law</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm">Create Client</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="newMatterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="newMatterForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Matter</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label class="form-label tiny">Matter title</label><input name="matterTitle"
                            class="form-control form-control-sm" required></div>
                    <div class="mb-2"><label class="form-label tiny">Client (name or email)</label><input
                            name="clientName" class="form-control form-control-sm"></div>
                    <div class="mb-2"><label class="form-label tiny">Practice area</label><input name="practiceArea"
                            class="form-control form-control-sm"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm">Create Matter</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="registerForm" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Register</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2"><label class="form-label tiny">Name</label><input name="name"
                            class="form-control form-control-sm"></div>
                    <div class="mb-2"><label class="form-label tiny">Role</label><input name="role"
                            class="form-control form-control-sm"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary btn-sm">Register</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Record Payment Modal -->
    <div class="modal fade" id="recordPaymentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">Record Payment</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="recordPaymentForm">
                        <div class="mb-3">
                            <label class="form-label small">Invoice ID</label>
                            <input type="text" id="rpInvoiceId" class="form-control form-control-sm" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Client</label>
                            <input type="text" id="rpClient" class="form-control form-control-sm" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Amount Due</label>
                            <input type="text" id="rpAmountDue" class="form-control form-control-sm" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">Amount Paid</label>
                            <input type="number" id="rpAmountPaid" class="form-control form-control-sm" min="0">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="btnSavePayment" class="btn btn-sm btn-primary">Save Payment</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="addEventModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="addEventForm">
                    <div class="modal-header">
                        <h6 class="modal-title">Add Calendar Event</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-2">
                            <label class="form-label tiny">Title</label>
                            <input type="text" id="addEventTitle" class="form-control form-control-sm" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label tiny">Client (optional)</label>
                            <select name="client" id="eventClientSelect" class="form-select form-select-sm" required>
                                <option value="">Select client...</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label class="form-label tiny">Date</label>
                            <input type="date" id="addEventDate" class="form-control form-control-sm" required>
                        </div>
                        <div class="mb-2">
                            <label class="form-label tiny">Type</label>
                            <select id="addEventType" class="form-select form-select-sm">
                                <option>Hearing</option>
                                <option>Billing</option>
                                <option>Meeting</option>
                                <option>Task</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-light btn-sm" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary btn-sm">Add Event</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- JS libs -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

    <script>
        // Seed data (mirrors the original React seed)
        const STAGES = ["Intake", "Discovery", "Motions", "Trial", "Closed"];
        let matters = [
            { id: "MAT-24012", title: "Nguyen v. Atlas Logistics", client: "Lan Nguyen", practice: "Employment", stage: "Discovery", next: "Deposition prep – Oct 10", percent: 42 },
            { id: "MAT-24019", title: "Estate of Chen", client: "Estate of Li Chen", practice: "Estates", stage: "Intake", next: "Collect medical files", percent: 8 },
            { id: "MAT-24021", title: "R. v. Patel", client: "Arjun Patel", practice: "Criminal", stage: "Motions", next: "Charter notice – due Oct 6", percent: 58 },
            { id: "MAT-24028", title: "Tran v. City of Hamilton", client: "Minh Tran", practice: "Civil", stage: "Trial", next: "Jury selection – Nov 18", percent: 82 },
        ];
        let hearings = [
            { id: 1, matter: "R. v. Patel", court: "ON Superior Court", type: "Motion", date: "2025-10-06", room: "3A", status: "Scheduled", client: "Arjun Patel", clientPhone: "+1 647 555 2233", clientEmail: "arjun.patel@example.com" },
            { id: 2, matter: "Nguyen v. Atlas Logistics", court: "ON Small Claims", type: "Settlement Conf.", date: "2025-10-15", room: "2C", status: "Scheduled", client: "Lan Nguyen", clientPhone: "+1 416 555 9912", clientEmail: "lan.nguyen@example.com" },
            { id: 3, matter: "Tran v. City of Hamilton", court: "ON Superior Court", type: "Trial", date: "2025-11-18", room: "1D", status: "Confirmed", client: "Minh Tran", clientPhone: "+1 289 555 4022", clientEmail: "minh.tran@example.com" },
        ];
        let invoices = [
            { id: "INV-1045", client: "Lan Nguyen", matter: "Nguyen v. Atlas Logistics", amount: 2450, due: "2025-10-12", status: "Unpaid" },
            { id: "INV-1046", client: "Estate of Li Chen", matter: "Estate of Chen", amount: 780, due: "2025-10-20", status: "Unpaid" },
            { id: "INV-1040", client: "Arjun Patel", matter: "R. v. Patel", amount: 920, due: "2025-09-20", status: "Overdue" },
            { id: "INV-1034", client: "Minh Tran", matter: "Tran v. City of Hamilton", amount: 3130, due: "2025-10-28", status: "Partially Paid" },
        ];
        let clients = [
            { name: "Lan Nguyen", email: "lan.nguyen@example.com", phone: "+1 416 555 9912", company: "Self", typeCourtClientDocument: 'Civil Litigation' },
            { name: "Arjun Patel", email: "arjun.patel@example.com", phone: "+1 647 555 2233", company: "Self", typeCourtClientDocument: 'Family Law' },
            { name: "Estate of Li Chen", email: "executor@chenestate.org", phone: "+1 905 555 8080", company: "Estate", typeCourtClientDocument: 'Criminal Defense' },
            { name: "Minh Tran", email: "minh.tran@example.com", phone: "+1 289 555 4022", company: "Self", typeCourtClientDocument: 'Immigration Law' },
            { name: "Hoang Anh", email: "hoanganh.lks@example.com", phone: "+1 289 555 4022", company: "Self", typeCourtClientDocument: 'Corporate Law' },
        ];
        let masterEvents = [
            { id: '1', title: 'Hearing: Lan Nguyen', start: '2025-10-12', client: 'Lan Nguyen', type: 'Hearing' },
            { id: '2', title: 'Invoice Due: Arjun Patel', start: '2025-10-18', client: 'Arjun Patel', type: 'Billing' },
            { id: '3', title: 'Mediation Meeting', start: '2025-10-20', client: 'Estate of Li Chen', type: 'Meeting' }
        ];
        // Utilities
        function updateStats() {
            $('#stat-active-matters').text(matters.filter(m => m.stage !== "Closed").length);
            $('#stat-hearings').text(hearings.length);
            const dueAmount = invoices.reduce((s, i) => s + ((i.status !== "Paid") ? i.amount : 0), 0);
            $('#stat-invoices').text(invoices.filter(i => i.status !== "Paid").length);
            $('#stat-invoices-amount').text(`$ ${dueAmount.toLocaleString()} due`);
        }

        function renderStages(filterQuery = '') {
            const container = $('#stagesContainer').empty();
            STAGES.forEach(stage => {
                const column = $('<div class="stage-column"></div>');
                const header = $(`<div class="d-flex align-items-center justify-content-between mb-2"><div><strong>${stage}</strong></div><div class="tiny badge-pill bg-light text-muted">${matters.filter(m => m.stage === stage).length}</div></div>`);
                column.append(header);
                const list = $('<div class="d-flex flex-column gap-3"></div>');
                const items = matters.filter(m => m.stage === stage && ([m.id, m.title, m.client, m.practice].join(' ').toLowerCase().includes(filterQuery.toLowerCase())));
                if (items.length === 0) {
                    list.append('<div class="tiny text-muted border border-dashed rounded-3 p-3 text-center">No items</div>');
                } else {
                    items.forEach(m => {
                        const card = $(`
              <div class="matter-card">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="title"><a href="#" class="open-client-link" data-client="${m.client}">${m.title}</a></div>
                    <div class="tiny text-muted">${m.client} • ${m.practice}</div>
                  </div>
                  <div>
                    <button class="btn btn-sm btn-outline-secondary advance-btn" data-id="${m.id}" title="Advance">…</button>
                  </div>
                </div>
                <div class="tiny text-muted mt-2">Next: ${m.next}</div>
                <div class="mt-2">
                  <div class="progress" style="height:8px;">
                    <div class="progress-bar" role="progressbar" style="width:${m.percent}%;" aria-valuenow="${m.percent}" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
            `);
                        list.append(card);
                    });
                }
                column.append(list);
                container.append(column);
            });
        }

        function renderHearings() {
            const tbody = $('#hearingsTable tbody').empty();
            hearings.forEach(h => {
                const statusBadge = h.status === 'Confirmed' ? '<span class="badge bg-success">Confirmed</span>' : (h.status === 'Overdue' ? '<span class="badge bg-danger">Overdue</span>' : '<span class="badge bg-secondary">Scheduled</span>');
                const tr = $(`
          <tr>
            <td>${new Date(h.date).toLocaleDateString()}</td>
            <td><a href="#" class="open-client-link" data-client="${h.client}">${h.matter}</a></td>
            <td>${h.court} (${h.type})</td>
            <td>${h.room}</td>
            <td>${statusBadge}</td>
          </tr>
        `);
                tbody.append(tr);
            });

            // Court table same data (for court tab)
            const courtTbody = $('#courtTable tbody').empty();
            hearings.forEach(h => {
                const notifyBtn = `<button class="btn btn-sm btn-outline-primary notify-btn" data-id="${h.id}">Send Email+SMS</button>`;
                courtTbody.append(`<tr>
          <td>${new Date(h.date).toLocaleDateString()}</td>
          <td><a href="#" class="open-client-link" data-client="${h.client}">${h.matter}</a></td>
          <td>${h.court} (${h.type})</td>
          <td>${h.room}</td>
          <td><span class="badge bg-info">${h.status}</span></td>
          <td>${notifyBtn}</td>
        </tr>`);
            });
        }

        function renderClients() {
            const tbody = $('#clientsTable tbody').empty();
            clients.forEach(c => {
                const tr = $(`
          <tr>
            <td><strong class="">${c.name}</strong><div class="tiny text-muted">Active</div></td>
            <td class="tiny text-muted">${c.email}</td>
            <td class="tiny text-muted">${c.phone}</td>
            <td class="tiny text-muted">${c.company}</td>
            <td class="tiny text-muted">${c.typeCourtClientDocument || '-'}</td>
            <td class="text-end"><button class="btn btn-sm btn-dark open-client-profile-btn" data-email="${c.email}">Open</button></td>
          </tr>
        `);
                tbody.append(tr);
            });
        }

        function renderMattersList() {
            const container = $('#mattersListArea').empty();
            const table = $(`
        <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>ID</th><th>Title</th><th>Client</th><th>Practice</th><th>Stage</th><th>Progress</th><th class="text-end">Action</th></tr></thead>
          <tbody></tbody>
        </table>
        </div>
      `);
            matters.forEach(m => {
                table.find('tbody').append(`
          <tr>
            <td>${m.id}</td>
            <td><strong>${m.title}</strong></td>
            <td>${m.client}</td>
            <td>${m.practice}</td>
            <td><span class="badge bg-light text-muted">${m.stage}</span></td>
            <td style="width:180px;vertical-align:middle"><div class="progress" style="height:8px"><div class="progress-bar" style="width:${m.percent}%;"></div></div></td>
            <td class="text-end"><button class="btn btn-sm btn-dark open-client-profile-link" data-client="${m.client}">Open</button></td>
          </tr>
        `);
            });
            container.append(table);
        }

        function renderInvoices() {
            const tbody = $('#invoicesTable tbody').empty();
            invoices.forEach(i => {
                const status = i.status === 'Overdue' ? '<span class="badge bg-danger">Overdue</span>' : (i.status === 'Partially Paid' ? '<span class="badge bg-secondary">Partially Paid</span>' : (i.status === 'Unpaid' ? '<span class="badge bg-warning text-dark">Unpaid</span>' : '<span class="badge bg-success">Paid</span>'));
                tbody.append(`<tr>
          <td>${i.id}</td><td>${i.client}</td><td>${i.matter}</td><td>$${i.amount.toLocaleString()}</td><td>${new Date(i.due).toLocaleDateString()}</td><td>${status}</td><td><button class="btn btn-sm btn-dark">Record Payment</button></td>
        </tr>`);
            });
        }

        // Actions
        $(function () {
            updateStats();
            renderStages();
            renderHearings();
            renderClients();
            renderMattersList();
            renderInvoices();

            // Tab switching
            $('[data-tab]').on('click', function (e) {
                e.preventDefault();
                const tab = $(this).data('tab');
                $('.sidebar .nav-link').removeClass('active');
                $(this).addClass('active');
                $('main section').addClass('d-none');
                $(`#tab-${tab}`).removeClass('d-none');
            });

            // Global search - live filter matters & clients & hearings
            $('#globalSearch').on('input', function () {
                const q = $(this).val().trim().toLowerCase();
                renderStages(q);
                // filter clients
                $('#clientsTable tbody tr').each(function () {
                    const txt = $(this).text().toLowerCase();
                    $(this).toggle(txt.indexOf(q) !== -1);
                });
                // filter hearings
                $('#hearingsTable tbody tr').each(function () {
                    const txt = $(this).text().toLowerCase();
                    $(this).toggle(txt.indexOf(q) !== -1);
                });
            });

            // Advance matter stage
            $(document).on('click', '.advance-btn', function () {
                const id = $(this).data('id');
                const idx = matters.findIndex(m => m.id === id);
                if (idx === -1) return;
                const current = STAGES.indexOf(matters[idx].stage);
                const next = Math.min(current + 1, STAGES.length - 1);
                matters[idx].stage = STAGES[next];
                matters[idx].percent = Math.min(100, matters[idx].percent + 12);
                renderStages($('#globalSearch').val());
                renderMattersList();
                updateStats();
            });

            // Open client link (from matter / hearings)
            $(document).on('click', '.open-client-link, .open-client-btn', function (e) {
                e.preventDefault();
                const clientName = $(this).data('client') || $(this).data('email');
                // find client; if missing, show alert
                const client = clients.find(c => c.name === clientName || c.email === clientName);
                if (client) {
                    // switch to client tab (we'll open Clients view and highlight)
                    $('.sidebar .nav-link').removeClass('active');
                    $('.sidebar .nav-link[data-tab="clients"]').addClass('active');
                    $('main section').addClass('d-none');
                    $('#tab-clients').removeClass('d-none');
                    // optionally scroll to the client row
                    $('#clientsTable tbody tr').filter(function () { return $(this).text().indexOf(client.name) !== -1; }).get(0)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    alert('Client profile not found: ' + clientName);
                }
            });

            // New Client form submit
            $('#newClientForm').on('submit', function (e) {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(this).entries());

                const newClient = {
                    name: data.clientName || 'Unnamed Client',
                    email: data.clientEmail || '',
                    phone: data.phone || '',
                    company: data.company || 'Self',
                    typeCourtClientDocument: data.courtType || 'Civil Litigation'  // 🔹 lưu loại hồ sơ mới
                };

                clients.unshift(newClient);

                // auto-create a matter for this client
                const newMatter = {
                    id: 'MAT-' + Math.floor(Math.random() * 9000 + 1000),
                    title: `New Matter for ${newClient.name}`,
                    client: newClient.name,
                    practice: newClient.typeCourtClientDocument, // 🔹 gắn type vào matter
                    stage: 'Intake',
                    next: 'Add details & documents',
                    percent: 0
                };

                matters.unshift(newMatter);

                renderClients();
                renderStages();
                renderMattersList();
                updateStats();

                $('#newClientModal').modal('hide');
                this.reset();

                // switch to client tab and highlight
                $('.sidebar .nav-link').removeClass('active');
                $('.sidebar .nav-link[data-tab="clients"]').addClass('active');
                $('main section').addClass('d-none');
                $('#tab-clients').removeClass('d-none');
            });

            // New Matter form submit
            $('#newMatterForm').on('submit', function (e) {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(this).entries());
                const newMatter = { id: 'MAT-' + Math.floor(Math.random() * 9000 + 1000), title: data.matterTitle || 'New Matter', client: data.clientName || 'Unassigned', practice: data.practiceArea || 'General', stage: 'Intake', next: 'Review intake details', percent: 2 };
                matters.unshift(newMatter);
                renderStages();
                renderMattersList();
                updateStats();
                $('#newMatterModal').modal('hide');
                this.reset();
            });

            // Register form
            $('#registerForm').on('submit', function (e) {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(this).entries());
                alert('Registered: ' + (data.name || 'Unnamed'));
                $('#registerModal').modal('hide');
            });

            // mini calendar
            $('#miniCalendar').on('change', function () { $('#miniCalSelected').text(this.value || '—'); });

            // notify button
            $(document).on('click', '.notify-btn', function () { alert('Pretend sending email+SMS for hearing id ' + $(this).data('id')); });

            // window resize: ensure stage columns visible (small screens can scroll)
            $(window).on('resize', function () { /* placeholder for responsive adjustments */ });

            // accessibility: close modals on escape handled by bootstrap
        });

        let currentClient = null;
        // ========== CLIENT PROFILE ==========
        function renderClientProfile(clientName) {
            const client = clients.find(c => c.name === clientName || c.email === clientName);
            if (!client) { alert("Client not found: " + clientName); return; }

            // ✅ Ghi nhớ client hiện tại
            currentClient = client;
            currentClientType = client.typeCourtClientDocument || "Civil Litigation";

            // ✅ Nếu client chưa có documentStructure riêng → tạo mới
            if (!client.documentStructure) {
                initDocumentStructureForClient(currentClientType);
                client.documentStructure = JSON.parse(JSON.stringify(documentStructure));
            } else {
                // Nếu có rồi → load lại từ client
                documentStructure = JSON.parse(JSON.stringify(client.documentStructure));
            }

            const relatedMatters = matters.filter(m => m.client === client.name);
            const relatedInvoices = invoices.filter(i => i.client === client.name);
            const relatedHearings = hearings.filter(h => h.client === client.name);

            let html = `
        <div class="row g-3">
          <div class="col-md-3">
            <div class="border rounded-3 p-3 h-100">
              <div class="text-center mb-3">
                <div class="rounded-circle bg-light d-inline-flex align-items-center justify-content-center" 
                     style="width:80px;height:80px;font-size:28px;font-weight:600;color:#2563eb;">
                  ${client.name.split(' ').map(n => n[0]).join('')}
                </div>
              </div>
              <h6 class="text-center mb-0">${client.name}</h6>
              <p class="text-center tiny text-muted">${client.company}</p>
              <hr>
              <div class="tiny"><i class="bi bi-envelope me-2"></i>${client.email || '—'}</div>
              <div class="tiny"><i class="bi bi-telephone me-2"></i>${client.phone || '—'}</div>
              <div class="mt-3">
                <span class="badge bg-primary">Active</span>
              </div>
            </div>
          </div>

          <div class="col-md-9">
            <ul class="nav nav-tabs small" id="clientTabNav">
              <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#clientMatters">Matters</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#clientInvoices">Invoices</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#clientHearings">Hearings</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#clientBilling">Billing</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#clientMessages">Messages</a></li>
              <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#clientDocuments">Documents</a></li>
            </ul>

            <div class="tab-content mt-3">
              <!-- Matters -->
              <div class="tab-pane fade show active" id="clientMatters">
                <div class="table-responsive">
                  <table class="table table-sm">
                    <thead><tr><th>ID</th><th>Title</th><th>Stage</th><th>Progress</th></tr></thead>
                    <tbody>
                      ${relatedMatters.map(m => `
                        <tr><td>${m.id}</td><td>${m.title}</td><td>${m.stage}</td>
                        <td style="vertical-align:middle"><div class="progress" style="height:8px;"><div class="progress-bar" style="width:${m.percent}%"></div></div></td></tr>
                      `).join('') || `<tr><td colspan="4" class="tiny text-muted">No matters yet</td></tr>`}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Invoices -->
                <div class="tab-pane fade" id="clientInvoices">
                    <div class="table-responsive">
                    <table class="table table-sm">
                        <thead><tr><th>ID</th><th>Amount</th><th>Due</th><th>Status</th></tr></thead>
                        <tbody>
                        ${relatedInvoices.map(i => `
                            <tr><td>${i.id}</td><td>$${i.amount.toLocaleString()}</td>
                            <td>${new Date(i.due).toLocaleDateString()}</td>
                            <td>${i.status}</td></tr>
                        `).join('') || `<tr><td colspan="4" class="tiny text-muted">No invoices</td></tr>`}
                        </tbody>
                    </table>
                    </div>
                </div>

              <!-- Hearings -->
                <div class="tab-pane fade" id="clientHearings">
                    <div class="table-responsive">
                    <table class="table table-sm">
                        <thead><tr><th>Date</th><th>Court</th><th>Type</th><th>Status</th></tr></thead>
                        <tbody>
                        ${relatedHearings.map(h => `
                            <tr><td>${new Date(h.date).toLocaleDateString()}</td><td>${h.court}</td><td>${h.type}</td><td>${h.status}</td></tr>
                        `).join('') || `<tr><td colspan="4" class="tiny text-muted">No hearings</td></tr>`}
                        </tbody>
                    </table>
                    </div>
                </div>

              <!-- Billing -->
                <div class="tab-pane fade" id="clientBilling">
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                        <thead>
                            <tr><th>ID</th><th>Amount</th><th>Due</th><th>Status</th><th></th></tr>
                        </thead>
                        <tbody id="billingTableBody"></tbody>
                        </table>
                    </div>
                </div>

              <!-- Messages -->
                <div class="tab-pane fade" id="clientMessages">
                    <div class="border rounded-2 p-3 mb-2" style="height:250px; overflow:auto;" id="msgThread"></div>
                    <div class="d-flex gap-2">
                        <input id="msgInput" class="form-control form-control-sm" placeholder="Write a message…" />
                        <button id="sendMsgBtn" class="btn btn-sm btn-primary">Send</button>
                    </div>
                 </div>
              <!-- Documents -->
                <div class="tab-pane fade" id="clientDocuments">
                    <div class="d-flex flex-column mb-3">
                        <h6 class="mb-2">Client Documents</h6>
                        <div id="docAlert" class="alert d-none p-2 mb-2 small" role="alert"></div>
                        <div class="d-flex gap-2">
                            <select id="folderSelect" class="form-select form-select-sm" style="width:auto;"></select>
                            <select id="subfolderSelect" class="form-select form-select-sm" style="width:auto;"></select>
                            <input type="file" id="uploadFile" class="form-control form-control-sm" style="width:auto;">
                            <button id="btnUploadDoc" class="btn btn-sm btn-primary">Upload</button>
                        </div>
                    </div>
                    <div id="docFolders" class="accordion accordion-border accordion-flush" ></div>
                </div>
            </div>
          </div>
        </div>
      `;
            $('#clientProfileBody').html(html);
            renderDocuments();

            // load previous messages if any
            renderMessages(client.email);
            $('#tab-client-profile').removeClass('d-none');
            $('main section').not('#tab-client-profile').addClass('d-none');
            $('.sidebar .nav-link').removeClass('active');
        }

        const threads = {}; // message threads by client email

        function renderMessages(email) {
            const msgs = threads[email] || [];
            const box = $('#msgThread').empty();
            if (msgs.length === 0) { box.append('<div class="tiny text-muted">No messages yet.</div>'); return; }
            msgs.forEach(m => {
                const align = m.from === 'You' ? 'text-end' : 'text-start';
                box.append(`<div class="${align} mb-2"><span class="badge bg-${m.from === 'You' ? 'primary' : 'light text-dark'}">${m.text}</span><div class="tiny text-muted">${m.from}</div></div>`);
            });
            box.scrollTop(box[0].scrollHeight);
        }

        // ========== DOCUMENTS TAB ==========
        const documentStructuresByType = {
            "Civil Litigation": {
                "Client & Administrative Documents": [
                    "Client intake form",
                    "Retainer agreement",
                    "Authorization for release of information",
                    "Conflict check form"
                ],
                "Court Filings & Pleadings": [
                    "Statement of Claim / Complaint / Notice of Action",
                    "Statement of Defence / Answer",
                    "Counterclaim / Crossclaim / Third-Party Claim",
                    "Reply or Response to Defence",
                    "Notice of Motion / Motion Record",
                    "Affidavit(s)",
                    "Memorandum of Law / Factum",
                    "Consent Orders / Draft Orders",
                    "Judgment / Order"
                ],
                "Discovery & Evidence": [
                    "Affidavit of Documents / Discovery Disclosure",
                    "List of Documents / Exhibits",
                    "Interrogatories and Responses",
                    "Requests to Admit and Responses",
                    "Examination for Discovery transcripts",
                    "Expert Reports / Witness Statements"
                ],
                "Pre-Trial & Trial": [
                    "Pre-Trial Conference Brief",
                    "Trial Brief / Book of Authorities",
                    "Opening and Closing Submissions",
                    "Exhibit Book / Trial Record",
                    "Witness Summons / Subpoenas"
                ],
                "Post-Judgment": [
                    "Bill of Costs / Assessment of Costs",
                    "Writ of Seizure and Sale / Garnishment",
                    "Satisfaction of Judgment"
                ]
            },
            "Family Law": {
                "Client & Administrative": [
                    "Family law intake form",
                    "Retainer agreement",
                    "Financial disclosure authorization"
                ],
                "Court Filings": [
                    "Application for Divorce / Family Law Application",
                    "Answer / Response",
                    "Financial Statement (Form 13 or 13.1)",
                    "Parenting or Custody Affidavit",
                    "Child or Spousal Support Affidavit",
                    "Case Conference / Settlement Brief",
                    "Motion for Temporary Orders",
                    "Affidavit in Support of Motion",
                    "Consent Orders / Minutes of Settlement",
                    "Final Order / Divorce Order"
                ],
                "Supporting Documents": [
                    "Income tax returns, pay stubs, financial statements",
                    "Property valuations / appraisals",
                    "Parenting plan / visitation schedule",
                    "Child support worksheets"
                ],
                "Alternative Dispute Resolution": [
                    "Mediation / Arbitration Agreements",
                    "Memorandum of Understanding / Settlement Agreement"
                ]
            },
            "Criminal Defense": {
                "Client & Administrative": [
                    "Criminal case intake form",
                    "Retainer agreement",
                    "Authorization to release information",
                    "Confidentiality acknowledgment"
                ],
                "Court Filings": [
                    "Notice of Appearance / Designation of Counsel",
                    "Bail Application / Bail Review Materials",
                    "Disclosure Request to Crown",
                    "Motion / Application to Exclude Evidence",
                    "Affidavit in Support of Motion",
                    "Charter Application",
                    "Factum / Memorandum of Law",
                    "Notice of Appeal"
                ],
                "Evidence & Discovery": [
                    "Crown disclosure package",
                    "Defence evidence list / witness list",
                    "Expert reports / forensic analyses",
                    "Examination transcripts",
                    "Cross-examination outlines"
                ],
                "Trial & Sentencing": [
                    "Opening statement notes",
                    "Closing submissions",
                    "Book of Authorities",
                    "Sentencing submissions / Pre-sentence report",
                    "Victim impact statements"
                ]
            },
            "Immigration Law": {
                "Client & Administrative": [
                    "Immigration intake form",
                    "Retainer agreement",
                    "Authorization to release information",
                    "Passport and ID copies"
                ],
                "Application & Supporting Forms": [
                    "Application forms (PR, visa, sponsorship, etc.)",
                    "Schedule A: Background / Declaration",
                    "Statutory Declarations",
                    "Proof of Relationship / Marriage Certificates",
                    "Police Certificates",
                    "Medical Examination Results",
                    "Proof of Funds",
                    "Employment / Education records",
                    "Reference letters",
                    "Affidavits / Statutory Declarations"
                ],
                "Refugee or Appeal Proceedings": [
                    "Basis of Claim Form",
                    "Personal Narrative / Supporting Evidence",
                    "Country Condition Reports",
                    "Hearing Disclosure Package",
                    "Memorandum of Argument",
                    "Notice of Appeal"
                ]
            },
            "Corporate Law": {
                "Client & Administrative": [
                    "Corporate client intake form",
                    "Retainer / engagement letter",
                    "Conflict check form",
                    "Authorization for representation"
                ],
                "Corporate Formation": [
                    "Articles of Incorporation / Organization",
                    "Bylaws / Operating Agreement",
                    "Shareholders’ Agreement",
                    "Directors’ and Officers’ Resolutions",
                    "Corporate Registry filings"
                ],
                "Contracts & Transactions": [
                    "Non-Disclosure Agreement (NDA)",
                    "Employment / Contractor Agreements",
                    "Purchase and Sale Agreements",
                    "Loan / Financing Agreements",
                    "Lease Agreements",
                    "Joint Venture / Partnership Agreements",
                    "Closing Documents / Checklist"
                ],
                "Corporate Governance": [
                    "Annual Resolutions",
                    "Minutes of Meetings",
                    "Corporate Records Book",
                    "Annual Returns / Compliance Filings"
                ],
                "Mergers & Acquisitions": [
                    "Letter of Intent / Term Sheet",
                    "Due Diligence Checklist and Reports",
                    "Share or Asset Purchase Agreement",
                    "Disclosure Schedules",
                    "Closing Certificates"
                ],
                "Dispute or Litigation": [
                    "Demand Letter / Notice of Default",
                    "Statement of Claim / Defence",
                    "Settlement Agreement / Release"
                ]
            }
        };

        let currentClientType = 'Civil Litigation';

        // Active document structure for the currently opened client:
        // { "Client & Administrative Documents": { "Client intake form": [file1,file2], ... }, ... }
        let documentStructure = {};

        // documentTemplatesByType: (giữ nguyên object bạn đã tạo trước đó)
        const documentTemplatesByType = documentStructuresByType; // nếu bạn dùng tên khác, cập nhật tương ứng

        // Khởi tạo documentStructure từ template theo type (gọi mỗi khi mở client profile)
        function initDocumentStructureForClient(type) {
            currentClientType = type || currentClientType;
            const tmpl = documentTemplatesByType[currentClientType] || documentTemplatesByType['Civil Litigation'];

            // build empty structure: folder -> sub -> []
            documentStructure = {};
            Object.entries(tmpl).forEach(([folder, subs]) => {
                documentStructure[folder] = {};
                // subs có thể là mảng tên subfolders
                if (Array.isArray(subs)) {
                    subs.forEach(sub => {
                        documentStructure[folder][sub] = []; // khởi tạo mảng files trống
                    });
                } else if (typeof subs === 'object' && subs !== null) {
                    // Nếu template dạng object (folder -> { sub: [] }), chuyển trực tiếp
                    Object.keys(subs).forEach(sub => {
                        documentStructure[folder][sub] = Array.isArray(subs[sub]) ? [...subs[sub]] : [];
                    });
                }
            });
        }

        // Populate selects (folder & subfolder) từ documentStructure hiện tại
        function populateFolderSelects() {
            const folderSelect = $('#folderSelect');
            const subSelect = $('#subfolderSelect');
            folderSelect.empty();
            const folders = Object.keys(documentStructure);
            if (folders.length === 0) {
                folderSelect.append(`<option disabled>-- No folders --</option>`);
                subSelect.empty().append(`<option disabled>-- No subfolders --</option>`);
                return;
            }
            folders.forEach(f => folderSelect.append(`<option value="${f}">${f}</option>`));
            const firstFolder = folderSelect.val();
            subSelect.empty();
            Object.keys(documentStructure[firstFolder]).forEach(s => subSelect.append(`<option value="${s}">${s}</option>`));
        }

        // Render accordion từ documentStructure (không từ các template trực tiếp)
        function renderDocuments() {
            // nếu chưa khởi tạo structure cho client hiện tại, khởi tạo mặc định
            if (!documentStructure || Object.keys(documentStructure).length === 0) {
                initDocumentStructureForClient(currentClientType);
            }

            let idx = 0;
            const html = Object.entries(documentStructure).map(([folder, subs]) => {
                const folderId = 'folder' + (++idx);
                const subsHtml = Object.entries(subs).map(([sub, files]) => {
                    // tạo id an toàn cho selector (loại bỏ ký tự đặc biệt)
                    const safeSub = sub.replace(/[^a-zA-Z0-9_-]/g, '_');
                    const subId = folderId + '-' + safeSub + '-' + Math.floor(Math.random() * 10000);
                    const fileItems = (files || []).map(f => `
        <li class="list-group-item d-flex justify-content-between align-items-center small">
          <span><i class="bi bi-file-earmark-text me-2 text-secondary"></i>${f}</span>
          <div>
            <button class="btn btn-sm btn-outline-primary btn-open-doc" data-doc="${f}">Open</button>
            <button class="btn btn-sm btn-outline-danger btn-del-doc" data-doc="${f}"><i class="bi bi-trash"></i></button>
          </div>
        </li>
      `).join('');
                    return `
        <div class="accordion-item border-0">
          <h2 class="accordion-header" id="heading-${subId}">
            <button class="accordion-button collapsed small bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${subId}" aria-controls="collapse-${subId}">
              <i class="bi bi-folder me-2 text-warning"></i>${sub}
            </button>
          </h2>
          <div id="collapse-${subId}" class="accordion-collapse collapse" aria-labelledby="heading-${subId}">
            <div class="accordion-body p-0">
              <ul class="list-group list-group-flush">${fileItems || '<li class="list-group-item tiny text-muted">No files yet</li>'}</ul>
            </div>
          </div>
        </div>
      `;
                }).join('');
                return `
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading${idx}">
          <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${idx}" aria-controls="collapse${idx}">
            <i class="bi bi-folder-fill text-warning me-2"></i>${folder}
          </button>
        </h2>
        <div id="collapse${idx}" class="accordion-collapse collapse" aria-labelledby="heading${idx}">
          <div class="accordion-body p-0">
            <div class="accordion accordion-flush">${subsHtml}</div>
          </div>
        </div>
      </div>
    `;
            }).join('');

            $('#docFolders').html(html);

            // populate selects và re-init collapse event để tránh "click lần 2 mới mở"
            populateFolderSelects();
            $('#docFolders .accordion-button').each(function () {
                const targetId = $(this).attr('data-bs-target');
                try {
                    const targetEl = document.querySelector(targetId);
                    if (targetEl) new bootstrap.Collapse(targetEl, { toggle: false });
                } catch (err) {
                    // bỏ qua selector không hợp lệ (an toàn), log cho debug
                    console.debug('Invalid selector when init collapse:', targetId);
                }
            });
        }

        function showDocAlert(message, type = 'success') {
            const alertBox = $('#docAlert');
            alertBox
                .removeClass('d-none alert-success alert-danger alert-warning alert-info')
                .addClass(`alert alert-${type}`)
                .text(message)
                .fadeIn();

            // Tự động ẩn sau 3 giây
            setTimeout(() => {
                alertBox.fadeOut(() => alertBox.addClass('d-none'));
            }, 3000);
        }

        // Khi mở tab Documents → render nội dung
        $(document).on('shown.bs.tab', 'a[href="#clientDocuments"]', function () {
            renderDocuments();
        });

        // Cập nhật subfolder khi chọn folder
        $(document).on('change', '#folderSelect', function () {
            const selected = $(this).val();
            const subSelect = $('#subfolderSelect');
            subSelect.empty();
            Object.keys(documentStructure[selected]).forEach(s => {
                subSelect.append(`<option value="${s}">${s}</option>`);
            });
        });

        // Upload tài liệu
        $(document).on('click', '#btnUploadDoc', function () {
            const fileInput = $('#uploadFile')[0];
            const file = fileInput.files[0];
            const folder = $('#folderSelect').val();
            const subfolder = $('#subfolderSelect').val();

            // ===== Kiểm tra trước khi upload =====
            if (!file) {
                showDocAlert("⚠️ Please select a file before uploading.", "warning");
                return;
            }

            if (!folder || !subfolder) {
                showDocAlert("⚠️ Please choose a folder and subfolder first.", "danger");
                return;
            }

            try {
                const fileName = file.name;

                // ===== Cập nhật document structure =====
                if (!documentStructure[folder]) documentStructure[folder] = {};
                if (!documentStructure[folder][subfolder]) documentStructure[folder][subfolder] = [];
                documentStructure[folder][subfolder].push(fileName);

                // Lưu lại cho client hiện tại
                if (currentClient)
                    currentClient.documentStructure = JSON.parse(JSON.stringify(documentStructure));

                // Render lại danh sách
                renderDocuments();

                // Reset file input
                fileInput.value = '';

                // Hiện thông báo thành công
                showDocAlert(`✅ File "${fileName}" uploaded successfully!`, "success");

            } catch (err) {
                console.error(err);
                showDocAlert("❌ Upload failed. Please try again.", "danger");
            }
        });

        // Mở tài liệu
        $(document).on('click', '.btn-open-doc', function () {
            const name = $(this).data('doc');
            alert(`📄 Opening document: ${name}`);
        });

        // Xoá tài liệu
        $(document).on('click', '.btn-del-doc', function () {
            const fileName = $(this).data('doc');
            const folder = $(this).closest('.accordion-item').parent().closest('.accordion-item')
                .find('.accordion-button.fw-semibold').text().trim();
            const subfolder = $(this).closest('.accordion-item').find('.accordion-button.small').text().trim();

            if (documentStructure[folder] && documentStructure[folder][subfolder]) {
                documentStructure[folder][subfolder] =
                    documentStructure[folder][subfolder].filter(f => f !== fileName);

                // ✅ Lưu lại cho client hiện tại
                if (currentClient)
                    currentClient.documentStructure = JSON.parse(JSON.stringify(documentStructure));

                renderDocuments();
            }
        });

        // handle send message
        $(document).on('click', '#sendMsgBtn', function () {
            const email = $('#clientProfileBody .tiny i.bi-envelope').parent().text().trim();
            const client = clients.find(c => c.email && email.includes(c.email));
            if (!client) return;
            const text = $('#msgInput').val().trim();
            if (!text) return;
            if (!threads[client.email]) threads[client.email] = [];
            threads[client.email].push({ from: 'You', text });
            $('#msgInput').val('');
            renderMessages(client.email);
        });

        // back button
        $(document).on('click', '#btnBackDashboard', function () {
            $('#tab-client-profile').addClass('d-none');
            $('#tab-clients').removeClass('d-none');
            $('.sidebar .nav-link').removeClass('active');
            $('.sidebar .nav-link[data-tab="dashboard"]').addClass('active');
        });
        $(document).on('click', '.sidebar .nav-link[data-tab="clients"], #btnBackDashboard', function () {
            currentClient = null;
            currentClientType = '';
            documentStructure = {};
        });

        // override open-client link to open profile directly
        $(document).off('click', '.open-client-profile-link, .open-client-profile-btn').on('click', '.open-client-profile-link, .open-client-profile-btn', function (e) {
            e.preventDefault();
            const clientName = $(this).data('client') || $(this).data('email');
            renderClientProfile(clientName);
        });

        // ========== BILLING / RECORD PAYMENT ==========

        // render bảng billing mỗi khi vào tab
        function renderBilling(clientName) {
            const clientInvoices = invoices.filter(i => i.client === clientName);
            const rows = clientInvoices.map(i => {
                const statusClass = i.status === 'Paid' ? 'bg-success'
                    : i.status === 'Partially Paid' ? 'bg-warning text-dark'
                        : i.status === 'Overdue' ? 'bg-danger'
                            : 'bg-secondary';
                return `
      <tr>
        <td>${i.id}</td>
        <td>$${i.amount.toLocaleString()}</td>
        <td>${new Date(i.due).toLocaleDateString()}</td>
        <td><span class="badge ${statusClass}">${i.status}</span></td>
        <td>
          <button class="btn btn-sm btn-outline-primary btn-record-payment" 
                  data-id="${i.id}" data-client="${i.client}">Record Payment</button>
        </td>
      </tr>`;
            }).join('') || `<tr><td colspan="5" class="tiny text-muted">No invoices</td></tr>`;

            $('#billingTableBody').html(rows);
        }

        // khi chuyển qua tab Billing
        $(document).on('shown.bs.tab', 'a[href="#clientBilling"]', function () {
            const clientName = $('#clientProfileBody h6.text-center').text();
            renderBilling(clientName);
        });

        // mở modal Record Payment
        $(document).on('click', '.btn-record-payment', function () {
            const invId = $(this).data('id');
            const inv = invoices.find(i => i.id === invId);
            if (!inv) return;

            $('#rpInvoiceId').val(inv.id);
            $('#rpClient').val(inv.client);
            $('#rpAmountDue').val('$' + inv.amount.toLocaleString());
            $('#rpAmountPaid').val('');
            const modal = new bootstrap.Modal(document.getElementById('recordPaymentModal'));
            modal.show();
        });

        // lưu thanh toán
        $(document).on('click', '#btnSavePayment', function () {
            const invId = $('#rpInvoiceId').val();
            const amountPaid = parseFloat($('#rpAmountPaid').val() || 0);
            const inv = invoices.find(i => i.id === invId);
            if (!inv) return;

            if (amountPaid <= 0) {
                alert('Please enter valid payment amount.');
                return;
            }

            if (amountPaid >= inv.amount) {
                inv.status = 'Paid';
            } else if (amountPaid > 0 && amountPaid < inv.amount) {
                inv.status = 'Partially Paid';
            } else {
                inv.status = 'Unpaid';
            }

            alert(`✅ Payment recorded for invoice ${inv.id}`);
            renderBilling(inv.client);
            bootstrap.Modal.getInstance(document.getElementById('recordPaymentModal')).hide();
        });

        function renderMasterCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                selectable: true,
                events: masterEvents,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                eventClick: function (info) {
                    const ev = info.event;
                    alert(`📌 ${ev.title}\nClient: ${ev.extendedProps.client || '—'}\nDate: ${ev.start.toLocaleDateString()}`);
                },
                dateClick: function (info) {
                    const date = info.dateStr;
                    $('#addEventDate').val(date);
                    $('#addEventModal').modal('show');
                    populateEventClientSelect();
                }
            });

            calendar.render();
        }
        function populateEventClientSelect() {
            const select = $('#eventClientSelect');
            select.empty().append('<option value="">Select client...</option>');
            if (!clients || clients.length === 0) {
                select.append('<option disabled>No clients available</option>');
                return;
            }
            clients.forEach(c => {
                select.append(`<option value="${c.name}">${c.name} (${c.company || 'Self'})</option>`);
            });
        }
        $(document).on('submit', '#addEventForm', function (e) {
            e.preventDefault();
            const title = $('#addEventTitle').val().trim();
            const client = $('#eventClientSelect').val().trim();
            const date = $('#addEventDate').val();
            const type = $('#addEventType').val();

            if (!title || !date) return;

            const newEvent = {
                id: 'E' + Math.floor(Math.random() * 100000),
                title,
                start: date,
                client,
                type
            };

            masterEvents.push(newEvent);
            $('#addEventModal').modal('hide');
            renderMasterCalendar();
        });
        $(document).on('click', '.sidebar .nav-link[data-tab="calendar"]', function () {
            $('main section').addClass('d-none');
            $('#tab-calendar').removeClass('d-none');
            renderMasterCalendar();
        });
    </script>
</body>

</html>